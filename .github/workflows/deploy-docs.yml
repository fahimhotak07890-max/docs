name: centralized deploy of versioned docs

on:
  push:
    branches:
      - '**'

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Exit if not a release branch
        run: |
          BRANCH="${GITHUB_REF##*/}"
          echo "Branch: $BRANCH"
          if [[ ! "$BRANCH" =~ ^release-v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Not a release branch. Exiting."
            exit 0
          fi

      - name: Fetch versions.yml from main
        run: |
          set -e
          git fetch origin main
          git show origin/main:versions.yml > versions.yml || {
            echo "‚ùå Could not fetch versions.yml from main"
            exit 1
          }

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Configure Git user
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Deploy current version docs using mike
        run: |
          python3 <<EOF
          import yaml
          import subprocess
          import os

          assert os.path.exists("versions.yml"), "versions.yml is missing!"

          with open("versions.yml", "r") as f:
              versions = yaml.safe_load(f).get("versions", [])

          if not versions:
              raise SystemExit("No versions defined in versions.yml")

          branch = os.environ.get("GITHUB_REF", "").split("/")[-1]         # e.g., release-v0.3.0
          target_version = branch.replace("release-v", "")                 # e.g., 0.3.0

          matched = [v for v in versions if v["version"] == target_version]
          if not matched:
              raise SystemExit(f"Version {target_version} not found in versions.yml")

          entry = matched[0]
          version = entry["version"]
          title = entry.get("title", version)
          aliases = entry.get("aliases", [])
          is_default = entry.get("default", False)

          deploy_cmd = ["mike", "deploy", f"{version}@{title}"] + aliases + ["--push"]
          print(f"üöÄ Deploying: {' '.join(deploy_cmd)}")
          result = subprocess.run(deploy_cmd, check=True, capture_output=True, text=True)
          print(result.stdout)
          print(result.stderr)

          if is_default:
              print(f"‚≠ê Setting {version} as default")
              result = subprocess.run(["mike", "set-default", version, "--push"], check=True, capture_output=True, text=True)
              print(result.stdout)
              print(result.stderr)
          EOF
